<div class="post-form-container">
  <div class="form-header">
    <h1>{{ pageTitle() }}</h1>
    <button class="btn-close-icon" (click)="onCancel()" title="Cerrar">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
        <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
      </svg>
    </button>
  </div>

  @if (isLoading()) {
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>{{ isEditMode() ? 'Cargando post...' : 'Guardando...' }}</p>
    </div>
  } @else {
    <form [formGroup]="postForm" (ngSubmit)="onSubmit()" class="post-form" novalidate>

      <!-- Title Field -->
      <div class="form-group">
        <label for="title" class="form-label">
          Título *
        </label>
        <div class="input-wrapper">
          <input
            type="text"
            id="title"
            formControlName="title"
            class="form-control"
            [class.is-invalid]="isFieldInvalid('title')"
            [class.is-valid]="isFieldValid('title')"
            placeholder="Ej: Mi experiencia usando Angular 18"
          >
          @if (isFieldValid('title')) {
            <div class="validation-icon valid">✓</div>
          }
          @if (isFieldInvalid('title')) {
            <div class="validation-icon invalid">✗</div>
          }
        </div>
        <div class="field-help">
          Mínimo 5 caracteres. No se permiten palabras como spam, fake, scam, virus.
        </div>
        @if (isFieldInvalid('title')) {
          <div class="error-message">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
            </svg>
            {{ getFieldError('title') }}
          </div>
        }
        @if (isFieldValid('title')) {
          <div class="success-message">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </svg>
            Título válido
          </div>
        }
      </div>

      <!-- Body Field -->
      <div class="form-group">
        <label for="body" class="form-label">
          Contenido *
        </label>
        <div class="input-wrapper">
          <textarea
            id="body"
            formControlName="body"
            class="form-control"
            [class.is-invalid]="isFieldInvalid('body')"
            [class.is-valid]="isFieldValid('body')"
            placeholder="Ejemplo: En este post quiero compartir mi experiencia desarrollando con Angular 18 y las nuevas características que más me han gustado..."
            rows="8"
          ></textarea>
          @if (isFieldValid('body')) {
            <div class="validation-icon valid">✓</div>
          }
          @if (isFieldInvalid('body')) {
            <div class="validation-icon invalid">✗</div>
          }
        </div>
        <div class="field-help">
          Mínimo 20 caracteres. Describe tu post de manera detallada y evita contenido spam.
        </div>
        @if (isFieldInvalid('body')) {
          <div class="error-message">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
            </svg>
            {{ getFieldError('body') }}
          </div>
        }
        @if (isFieldValid('body')) {
          <div class="success-message">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </svg>
            Contenido válido
          </div>
        }
      </div>

      <!-- User ID Field -->
      <div class="form-group">
        <label for="userId" class="form-label">Usuario *</label>
        <div class="input-wrapper">
          <select
            id="userId"
            formControlName="userId"
            class="form-control"
            [class.is-invalid]="isFieldInvalid('userId')"
            [class.is-valid]="isFieldValid('userId')"
          >
            <option value="" disabled>Seleccionar usuario</option>
            @for (userId of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; track userId) {
              <option [value]="userId">Usuario {{ userId }}</option>
            }
          </select>
          @if (isFieldValid('userId')) {
            <div class="validation-icon valid">✓</div>
          }
          @if (isFieldInvalid('userId')) {
            <div class="validation-icon invalid">✗</div>
          }
        </div>
        @if (isFieldInvalid('userId')) {
          <div class="error-message">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
            </svg>
            {{ getFieldError('userId') }}
          </div>
        }
      </div>

      @if (isEditMode() && postForm.valid && postForm.touched && !hasChanges()) {
        <div class="form-summary info">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
          </svg>
          No se han realizado cambios en el post
        </div>
      }

      <!-- Form Actions -->
      <div class="form-actions">
        <button
          type="button"
          class="btn-secondary"
          (click)="onCancel()"
          [disabled]="isLoading()"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="btn-primary"
          [class.loading]="isLoading()"
          [disabled]="!isSubmitEnabled()"
          [title]="getSubmitButtonTitle()"
        >
          @if (isLoading()) {
            <div class="button-spinner"></div>
            Guardando...
          } @else {
            {{ isEditMode() ? 'Actualizar' : 'Crear' }} Post
          }
        </button>
      </div>
    </form>
  }
</div>
